import { initializeApp, cert } from "firebase-admin/app";
import { getFirestore } from "firebase-admin/firestore"
import fs from "fs";
import fsPromise from "fs/promises";

type Score = { 
  personal: number;
  professional: number;
  spiritual: number;
  timestamp: number;
}
type DataFile = Record<number, [number, number, number]>;

function getCredentials(): any {
  const envCreds = process.env.FIREBASE_CREDENTIALS;
  if (envCreds !== undefined) return JSON.parse(envCreds);

  const credentials = JSON.parse(fs.readFileSync("../credentials.json", "utf-8"));
  return credentials;
}

const credential = cert(getCredentials());
const app = initializeApp({credential});
const db = getFirestore(app);

const historicCollection = db.collection("/historic");

function toUTC(date: Date): Date {
  return new Date(date.toUTCString());
}

function getDateBounds(date: Date): { start: number; end: number } {
  date = toUTC(date);
  date.setUTCHours(0, 0, 0, 0);
  const startMillis = date.getTime();
  const start = Math.floor(startMillis / 1000);

  date.setUTCDate(date.getUTCDate() + 1);
  const endMillis = date.getTime();
  const end = Math.floor(endMillis / 1000);

  return { start, end };
}

function formatScore(score: Score): [number, number, number] {
  return [score.personal, score.professional, score.spiritual];
}

async function fetchData(start: Date, end: Date): Promise<Score[]> {
  return JSON.parse(`[{"spiritual":6,"professional":6,"personal":7,"timestamp":1656517708},{"spiritual":9,"professional":6,"timestamp":1656520273,"personal":7},{"professional":6,"personal":7,"timestamp":1656520337,"spiritual":6},{"personal":7,"timestamp":1656520355,"professional":6,"spiritual":7},{"timestamp":1656520364,"professional":6,"spiritual":6,"personal":7},{"spiritual":5,"professional":6,"timestamp":1656520413,"personal":7},{"spiritual":6,"professional":6,"timestamp":1656520449,"personal":7},{"professional":6,"timestamp":1656520472,"spiritual":5,"personal":7},{"spiritual":6,"personal":7,"professional":6,"timestamp":1656520480},{"professional":7,"personal":8,"timestamp":1656521638,"spiritual":6},{"timestamp":1656522789,"spiritual":6,"professional":7,"personal":7},{"spiritual":6,"personal":7,"timestamp":1656522801,"professional":6},{"spiritual":7,"professional":7,"timestamp":1656523650,"personal":6},{"personal":6,"timestamp":1656524587,"spiritual":7,"professional":7},{"professional":8,"personal":5,"spiritual":8,"timestamp":1656530522},{"professional":7,"personal":6,"spiritual":7,"timestamp":1656534915},{"timestamp":1656534950,"spiritual":9,"personal":6,"professional":7},{"timestamp":1656534956,"professional":7,"personal":6,"spiritual":7},{"personal":6,"timestamp":1656534985,"spiritual":9,"professional":7},{"personal":6,"spiritual":7,"timestamp":1656534993,"professional":7},{"personal":7,"spiritual":7,"timestamp":1656537402,"professional":7},{"timestamp":1656541448,"spiritual":7,"personal":6,"professional":7},{"spiritual":7,"timestamp":1656543277,"personal":6,"professional":7},{"personal":7,"professional":8,"timestamp":1656543298,"spiritual":7},{"personal":7,"timestamp":1656543339,"professional":8,"spiritual":8},{"personal":8,"timestamp":1656581722,"professional":7,"spiritual":8},{"personal":8,"timestamp":1656582161,"professional":3,"spiritual":8},{"timestamp":1656582167,"professional":6,"personal":8,"spiritual":8},{"personal":8,"spiritual":8,"professional":7,"timestamp":1656582168},{"spiritual":8,"timestamp":1656582184,"personal":8,"professional":4},{"timestamp":1656582188,"professional":7,"personal":8,"spiritual":8},{"spiritual":5,"timestamp":1656582199,"professional":7,"personal":8},{"professional":7,"spiritual":8,"timestamp":1656582202,"personal":8},{"timestamp":1656582211,"professional":7,"personal":7,"spiritual":8},{"professional":7,"timestamp":1656585507,"spiritual":8,"personal":8},{"timestamp":1656585511,"spiritual":7,"professional":7,"personal":8},{"professional":7,"spiritual":7,"timestamp":1656586160,"personal":7},{"timestamp":1656586164,"professional":6,"personal":7,"spiritual":7},{"timestamp":1656586897,"professional":7,"personal":6,"spiritual":7},{"personal":6,"spiritual":6,"professional":7,"timestamp":1656586899},{"timestamp":1656587847,"professional":7,"personal":7,"spiritual":6},{"personal":7,"timestamp":1656588531,"spiritual":7,"professional":7},{"spiritual":7,"personal":8,"timestamp":1656592071,"professional":7},{"personal":8,"professional":6,"timestamp":1656592074,"spiritual":6},{"timestamp":1656593032,"spiritual":6,"professional":6,"personal":7},{"timestamp":1656594096,"professional":7,"spiritual":6,"personal":7},{"personal":7,"professional":7,"timestamp":1656596717,"spiritual":7},{"professional":7,"timestamp":1656601381,"personal":8,"spiritual":7},{"spiritual":7,"personal":7,"timestamp":1656602941,"professional":7},{"timestamp":1656602944,"spiritual":7,"professional":8,"personal":7},{"timestamp":1656606127,"personal":7,"professional":7,"spiritual":7},{"timestamp":1656609168,"spiritual":8,"professional":7,"personal":6},{"spiritual":8,"professional":7,"timestamp":1656610562,"personal":5},{"timestamp":1656611555,"professional":6,"spiritual":7,"personal":5},{"professional":6,"spiritual":7,"timestamp":1656614901,"personal":6},{"timestamp":1656619324,"professional":6,"spiritual":7,"personal":7},{"professional":6,"spiritual":7,"timestamp":1656622022,"personal":6},{"timestamp":1656624742,"personal":6,"professional":7,"spiritual":7},{"personal":7,"professional":7,"spiritual":7,"timestamp":1656624744},{"personal":6,"professional":7,"timestamp":1656629164,"spiritual":7},{"timestamp":1656629183,"professional":6,"personal":6,"spiritual":7},{"professional":6,"personal":5,"spiritual":7,"timestamp":1656630550},{"spiritual":7,"professional":6,"timestamp":1656665234,"personal":7},{"professional":6,"personal":5,"spiritual":7,"timestamp":1656665240},{"professional":6,"personal":7,"timestamp":1656665251,"spiritual":7},{"timestamp":1656665253,"professional":6,"personal":6,"spiritual":7},{"professional":6,"personal":5,"spiritual":7,"timestamp":1656665255},{"timestamp":1656665260,"personal":7,"professional":6,"spiritual":7},{"professional":6,"timestamp":1656665263,"personal":5,"spiritual":7},{"professional":7,"personal":7,"spiritual":7,"timestamp":1656665272},{"spiritual":7,"professional":6,"timestamp":1656665273,"personal":7},{"spiritual":7,"timestamp":1656665274,"professional":7,"personal":7},{"personal":6,"professional":7,"spiritual":7,"timestamp":1656666539},{"professional":7,"personal":7,"timestamp":1656668650,"spiritual":7},{"timestamp":1656668651,"spiritual":7,"professional":7,"personal":6},{"timestamp":1656676934,"professional":8,"spiritual":7,"personal":5},{"timestamp":1656679466,"spiritual":7,"professional":7,"personal":5},{"timestamp":1656681197,"personal":6,"professional":7,"spiritual":7},{"spiritual":7,"professional":6,"timestamp":1656681361,"personal":6},{"personal":7,"professional":7,"spiritual":7,"timestamp":1656684858},{"professional":7,"personal":7,"spiritual":6,"timestamp":1656684871},{"spiritual":6,"professional":7,"personal":6,"timestamp":1656686550},{"professional":7,"timestamp":1656690639,"personal":6,"spiritual":7},{"personal":6,"spiritual":7,"professional":6,"timestamp":1656693674},{"timestamp":1656694422,"spiritual":6,"professional":5,"personal":6},{"professional":5,"timestamp":1656694427,"spiritual":6,"personal":5},{"professional":5,"personal":4,"timestamp":1656695687,"spiritual":6},{"timestamp":1656696290,"spiritual":6,"professional":5,"personal":5},{"personal":6,"professional":5,"spiritual":6,"timestamp":1656697262},{"professional":5,"personal":7,"spiritual":6,"timestamp":1656698280},{"timestamp":1656706281,"professional":5,"personal":7,"spiritual":7},{"spiritual":7,"timestamp":1656708325,"personal":6,"professional":5},{"timestamp":1656710529,"spiritual":7,"professional":5,"personal":5},{"spiritual":7,"professional":5,"timestamp":1656717659,"personal":4},{"personal":4,"spiritual":7,"timestamp":1656717665,"professional":6},{"timestamp":1656717669,"professional":6,"spiritual":6,"personal":4},{"professional":6,"personal":7,"timestamp":1656753436,"spiritual":6},{"timestamp":1656754761,"personal":7,"spiritual":6,"professional":5},{"spiritual":6,"professional":6,"timestamp":1656756624,"personal":7},{"spiritual":6,"personal":7,"timestamp":1656760965,"professional":7},{"professional":7,"personal":6,"spiritual":6,"timestamp":1656762488},{"timestamp":1656762492,"professional":7,"personal":5,"spiritual":6},{"professional":7,"timestamp":1656762901,"spiritual":6,"personal":6},{"timestamp":1656763621,"professional":7,"personal":7,"spiritual":6},{"spiritual":6,"professional":8,"personal":7,"timestamp":1656765371},{"timestamp":1656765376,"personal":7,"spiritual":7,"professional":8},{"personal":7,"timestamp":1656766789,"spiritual":7,"professional":7},{"spiritual":7,"personal":6,"timestamp":1656768287,"professional":6},{"timestamp":1656769730,"professional":6,"personal":7,"spiritual":7},{"spiritual":7,"professional":7,"timestamp":1656770621,"personal":7},{"professional":7,"spiritual":7,"timestamp":1656775621,"personal":6},{"professional":5,"timestamp":1656775624,"personal":6,"spiritual":7},{"timestamp":1656777163,"professional":6,"spiritual":7,"personal":6},{"professional":6,"spiritual":7,"timestamp":1656780054,"personal":5},{"personal":5,"spiritual":6,"professional":6,"timestamp":1656780729},{"spiritual":6,"timestamp":1656789141,"professional":6,"personal":7},{"professional":6,"timestamp":1656790143,"spiritual":6,"personal":6},{"personal":5,"spiritual":6,"timestamp":1656804307,"professional":6},{"timestamp":1656845805,"spiritual":6,"professional":6,"personal":7},{"personal":6,"professional":6,"timestamp":1656845807,"spiritual":6},{"timestamp":1656845809,"personal":6,"professional":5,"spiritual":6},{"professional":5,"spiritual":5,"personal":6,"timestamp":1656847626},{"professional":5,"timestamp":1656847750,"personal":5,"spiritual":5},{"timestamp":1656848716,"personal":6,"professional":5,"spiritual":5},{"professional":7,"timestamp":1656858414,"personal":6,"spiritual":5},{"spiritual":5,"timestamp":1656858415,"professional":7,"personal":5},{"timestamp":1656859820,"spiritual":5,"professional":7,"personal":6},{"professional":6,"timestamp":1656874267,"personal":7,"spiritual":5},{"personal":7,"timestamp":1656874268,"professional":6,"spiritual":6},{"professional":6,"timestamp":1656887500,"spiritual":6,"personal":6},{"professional":6,"personal":5,"timestamp":1656890412,"spiritual":6},{"timestamp":1656926009,"professional":6,"spiritual":6,"personal":6},{"professional":5,"timestamp":1656929118,"personal":7,"spiritual":6},{"spiritual":6,"timestamp":1656935288,"professional":5,"personal":5},{"timestamp":1656935504,"personal":5,"professional":5,"spiritual":5},{"professional":5,"personal":6,"spiritual":5,"timestamp":1656937572},{"spiritual":5,"timestamp":1656937822,"professional":5,"personal":5},{"timestamp":1656940210,"spiritual":5,"personal":4,"professional":5},{"timestamp":1656941664,"professional":5,"personal":5,"spiritual":5},{"personal":4,"spiritual":5,"professional":5,"timestamp":1656942256},{"timestamp":1656945038,"professional":5,"personal":5,"spiritual":5},{"personal":4,"spiritual":5,"timestamp":1656945273,"professional":5},{"personal":5,"professional":4,"spiritual":5,"timestamp":1656946016},{"timestamp":1656949132,"personal":6,"professional":4,"spiritual":5},{"timestamp":1656950880,"professional":4,"spiritual":5,"personal":5},{"spiritual":5,"professional":5,"timestamp":1656953501,"personal":5},{"spiritual":5,"timestamp":1656959942,"professional":4,"personal":6},{"timestamp":1656965033,"spiritual":5,"professional":4,"personal":3},{"personal":4,"timestamp":1656965035,"spiritual":5,"professional":4},{"timestamp":1656967470,"spiritual":5,"personal":5,"professional":4},{"timestamp":1656967471,"professional":3,"personal":5,"spiritual":5},{"timestamp":1657011366,"professional":3,"personal":5,"spiritual":6},{"professional":5,"timestamp":1657011368,"personal":5,"spiritual":6},{"personal":6,"spiritual":6,"timestamp":1657011369,"professional":5},{"personal":5,"spiritual":6,"timestamp":1657012935,"professional":5},{"personal":5,"spiritual":5,"timestamp":1657012936,"professional":5},{"spiritual":5,"timestamp":1657014023,"professional":5,"personal":6},{"professional":5,"timestamp":1657018870,"personal":5,"spiritual":5},{"professional":4,"personal":5,"timestamp":1657021854,"spiritual":5},{"professional":5,"personal":5,"spiritual":5,"timestamp":1657026066},{"timestamp":1657027151,"personal":6,"professional":6,"spiritual":6},{"timestamp":1657029418,"spiritual":7,"professional":6,"personal":6},{"professional":6,"personal":7,"timestamp":1657029419,"spiritual":7},{"timestamp":1657029423,"spiritual":7,"professional":7,"personal":7},{"timestamp":1657033081,"spiritual":7,"professional":6,"personal":7},{"professional":6,"timestamp":1657039566,"spiritual":7,"personal":6},{"timestamp":1657043552,"professional":6,"spiritual":7,"personal":7},{"timestamp":1657045788,"professional":6,"spiritual":7,"personal":6},{"timestamp":1657097274,"personal":7,"spiritual":7,"professional":7},{"personal":6,"professional":6,"spiritual":7,"timestamp":1657105792},{"professional":6,"timestamp":1657110598,"spiritual":7,"personal":5},{"professional":5,"personal":5,"timestamp":1657118476,"spiritual":7},{"personal":5,"professional":5,"spiritual":6,"timestamp":1657118477},{"personal":4,"professional":5,"timestamp":1657119639,"spiritual":6},{"professional":5,"timestamp":1657120268,"personal":5,"spiritual":6},{"personal":4,"timestamp":1657123896,"spiritual":6,"professional":5},{"timestamp":1657124523,"personal":6,"professional":5,"spiritual":6},{"personal":7,"timestamp":1657127410,"professional":6,"spiritual":7},{"timestamp":1657143847,"professional":6,"personal":7,"spiritual":6},{"professional":6,"timestamp":1657144543,"personal":6,"spiritual":6},{"spiritual":6,"timestamp":1657186162,"professional":5,"personal":6},{"professional":5,"personal":6,"timestamp":1657192044,"spiritual":7},{"timestamp":1657192177,"personal":4,"professional":5,"spiritual":7},{"personal":5,"spiritual":7,"timestamp":1657192179,"professional":5},{"professional":5,"personal":6,"spiritual":7,"timestamp":1657193388},{"personal":5,"timestamp":1657197610,"professional":5,"spiritual":7},{"spiritual":7,"timestamp":1657198724,"personal":6,"professional":5},{"spiritual":7,"personal":7,"professional":5,"timestamp":1657201658},{"timestamp":1657204297,"personal":7,"spiritual":7,"professional":6},{"professional":5,"personal":7,"timestamp":1657210278,"spiritual":6},{"timestamp":1657210281,"personal":6,"professional":5,"spiritual":6},{"personal":5,"spiritual":6,"professional":5,"timestamp":1657210773},{"timestamp":1657212335,"spiritual":6,"professional":5,"personal":6},{"professional":5,"personal":5,"spiritual":6,"timestamp":1657215809},{"professional":5,"personal":4,"timestamp":1657219910,"spiritual":6},{"timestamp":1657225530,"professional":6,"spiritual":6,"personal":3},{"spiritual":6,"personal":4,"timestamp":1657226713,"professional":6},{"professional":6,"spiritual":6,"personal":6,"timestamp":1657231523},{"personal":6,"spiritual":6,"professional":6,"timestamp":1657231866},{"timestamp":1657235437,"professional":6,"spiritual":6,"personal":7},{"professional":6,"personal":8,"spiritual":6,"timestamp":1657237533},{"timestamp":1657274845,"personal":7,"spiritual":6,"professional":6},{"personal":7,"professional":6,"timestamp":1657274847,"spiritual":7},{"timestamp":1657283171,"professional":6,"spiritual":7,"personal":8},{"spiritual":7,"timestamp":1657283468,"professional":6,"personal":5},{"personal":7,"professional":6,"timestamp":1657286234,"spiritual":7},{"timestamp":1657286237,"personal":7,"professional":7,"spiritual":7},{"professional":7,"spiritual":7,"timestamp":1657287646,"personal":6},{"timestamp":1657295553,"spiritual":7,"professional":7,"personal":7},{"timestamp":1657299597,"spiritual":7,"professional":7,"personal":6},{"timestamp":1657302427,"spiritual":7,"professional":7,"personal":7},{"professional":7,"personal":6,"spiritual":7,"timestamp":1657319191},{"professional":7,"timestamp":1657321166,"spiritual":7,"personal":8},{"personal":7,"timestamp":1657326264,"spiritual":7,"professional":7},{"personal":8,"professional":7,"spiritual":7,"timestamp":1657372192},{"spiritual":7,"professional":7,"personal":7,"timestamp":1657373938},{"timestamp":1657391306,"spiritual":7,"professional":6,"personal":7},{"timestamp":1657398645,"professional":6,"personal":5,"spiritual":7},{"spiritual":7,"professional":6,"timestamp":1657444348,"personal":6},{"professional":6,"timestamp":1657470976,"personal":7,"spiritual":7},{"timestamp":1657470980,"professional":8,"personal":7,"spiritual":7},{"professional":8,"personal":7,"timestamp":1657470986,"spiritual":8},{"timestamp":1657486277,"personal":6,"professional":7,"spiritual":7},{"timestamp":1657496952,"personal":7,"spiritual":7,"professional":7},{"personal":6,"professional":7,"timestamp":1657556967,"spiritual":7},{"timestamp":1657556969,"professional":6,"personal":6,"spiritual":6},{"personal":6,"timestamp":1657556971,"spiritual":6,"professional":7},{"professional":7,"timestamp":1657561857,"spiritual":6,"personal":5},{"timestamp":1657563717,"professional":5,"personal":4,"spiritual":6},{"personal":4,"spiritual":5,"timestamp":1657563720,"professional":5},{"professional":5,"spiritual":5,"personal":6,"timestamp":1657565672},{"timestamp":1657566233,"spiritual":7,"professional":5,"personal":6},{"timestamp":1657568032,"spiritual":7,"personal":7,"professional":5},{"personal":7,"timestamp":1657568033,"spiritual":8,"professional":5},{"timestamp":1657576359,"personal":7,"spiritual":7,"professional":5},{"spiritual":7,"professional":5,"personal":6,"timestamp":1657586017},{"timestamp":1657593431,"personal":5,"spiritual":7,"professional":5},{"personal":8,"timestamp":1657622866,"professional":5,"spiritual":7},{"professional":6,"timestamp":1657622869,"spiritual":7,"personal":7},{"personal":7,"timestamp":1657622870,"spiritual":8,"professional":6},{"professional":6,"personal":6,"timestamp":1657622907,"spiritual":8},{"personal":7,"timestamp":1657622912,"professional":6,"spiritual":8},{"timestamp":1657627631,"personal":7,"professional":6,"spiritual":7},{"professional":6,"timestamp":1657647646,"personal":6,"spiritual":7},{"timestamp":1657670993,"professional":6,"personal":7,"spiritual":7},{"professional":7,"personal":7,"spiritual":7,"timestamp":1657670995},{"professional":7,"personal":5,"spiritual":7,"timestamp":1657675677},{"personal":5,"professional":7,"timestamp":1657675679,"spiritual":6},{"personal":4,"professional":7,"spiritual":6,"timestamp":1657705259},{"personal":3,"timestamp":1657708202,"professional":7,"spiritual":6},{"timestamp":1657709442,"professional":7,"spiritual":6,"personal":4},{"professional":7,"personal":5,"timestamp":1657710680,"spiritual":6},{"timestamp":1657710682,"spiritual":7,"professional":5,"personal":5},{"professional":5,"timestamp":1657712891,"spiritual":7,"personal":4},{"professional":5,"timestamp":1657726474,"spiritual":7,"personal":5},{"professional":5,"personal":6,"timestamp":1657737931,"spiritual":7},{"personal":6,"timestamp":1657741674,"spiritual":8,"professional":5},{"personal":6,"spiritual":7,"timestamp":1657746248,"professional":5},{"personal":5,"spiritual":7,"professional":5,"timestamp":1657789217},{"professional":5,"spiritual":7,"personal":6,"timestamp":1657798656},{"timestamp":1657798657,"personal":6,"spiritual":7,"professional":4},{"timestamp":1657803475,"professional":5,"personal":6,"spiritual":7},{"spiritual":7,"personal":5,"professional":5,"timestamp":1657817117},{"professional":5,"personal":6,"spiritual":7,"timestamp":1657823694},{"professional":5,"spiritual":7,"timestamp":1657830525,"personal":5},{"personal":4,"professional":5,"timestamp":1657876044,"spiritual":7},{"timestamp":1657893158,"personal":5,"professional":5,"spiritual":7},{"professional":6,"timestamp":1657895104,"personal":5,"spiritual":7},{"professional":7,"spiritual":7,"personal":5,"timestamp":1657897243},{"personal":5,"spiritual":7,"timestamp":1657901639,"professional":6},{"personal":5,"spiritual":7,"timestamp":1657910971,"professional":5},{"personal":6,"timestamp":1657927246,"spiritual":7,"professional":5},{"personal":6,"professional":6,"timestamp":1657966067,"spiritual":7},{"professional":5,"timestamp":1657986374,"spiritual":7,"personal":6},{"professional":5,"timestamp":1657993109,"personal":5,"spiritual":7},{"professional":5,"spiritual":7,"personal":4,"timestamp":1657995696},{"timestamp":1658001051,"spiritual":7,"personal":3,"professional":5},{"spiritual":7,"timestamp":1658001053,"professional":4,"personal":3},{"professional":4,"personal":3,"timestamp":1658001054,"spiritual":6},{"professional":4,"spiritual":6,"personal":2,"timestamp":1658005598},{"professional":4,"spiritual":6,"personal":3,"timestamp":1658005927},{"professional":4,"spiritual":6,"timestamp":1658014809,"personal":5},{"personal":6,"spiritual":6,"professional":5,"timestamp":1658081593},{"personal":6,"professional":6,"timestamp":1658084389,"spiritual":6},{"personal":5,"professional":6,"spiritual":6,"timestamp":1658085696},{"spiritual":6,"professional":6,"timestamp":1658092186,"personal":6},{"timestamp":1658135290,"professional":6,"personal":7,"spiritual":6},{"personal":6,"spiritual":6,"timestamp":1658136857,"professional":6},{"personal":4,"professional":5,"timestamp":1658164317,"spiritual":6},{"spiritual":6,"personal":5,"timestamp":1658165607,"professional":5},{"professional":5,"personal":6,"timestamp":1658169390,"spiritual":6},{"spiritual":6,"professional":5,"timestamp":1658175906,"personal":7},{"personal":7,"professional":6,"timestamp":1658175909,"spiritual":7},{"professional":6,"timestamp":1658219420,"personal":7,"spiritual":7},{"personal":7,"spiritual":7,"timestamp":1658222063,"professional":5},{"professional":5,"timestamp":1658223604,"spiritual":7,"personal":6},{"spiritual":7,"timestamp":1658224640,"personal":6,"professional":5},{"spiritual":7,"personal":7,"professional":5,"timestamp":1658243225},{"professional":6,"timestamp":1658243227,"personal":7,"spiritual":7},{"spiritual":8,"timestamp":1658314181,"professional":6,"personal":7},{"spiritual":7,"professional":6,"timestamp":1658328820,"personal":7},{"spiritual":7,"professional":7,"personal":7,"timestamp":1658410751},{"timestamp":1658420073,"personal":6,"spiritual":7,"professional":6},{"professional":6,"personal":5,"timestamp":1658481301,"spiritual":7},{"personal":7,"spiritual":7,"timestamp":1658504268,"professional":6},{"spiritual":6,"personal":6,"professional":6,"timestamp":1658523135},{"professional":6,"personal":5,"timestamp":1658570643,"spiritual":6},{"timestamp":1658583633,"professional":6,"personal":6,"spiritual":6},{"professional":7,"personal":6,"timestamp":1658587824,"spiritual":6},{"personal":5,"professional":7,"spiritual":5,"timestamp":1658591441},{"personal":4,"timestamp":1658598689,"spiritual":4,"professional":7},{"spiritual":3,"personal":4,"timestamp":1658598692,"professional":5},{"spiritual":3,"professional":5,"personal":3,"timestamp":1658598878},{"professional":5,"personal":4,"timestamp":1658600454,"spiritual":3},{"timestamp":1658604278,"personal":4,"spiritual":4,"professional":5},{"personal":5,"professional":5,"spiritual":4,"timestamp":1658621044},{"personal":5,"professional":6,"timestamp":1658658911,"spiritual":4},{"spiritual":5,"personal":6,"timestamp":1658658914,"professional":6},{"spiritual":5,"professional":7,"timestamp":1658665227,"personal":6},{"spiritual":5,"timestamp":1658665372,"professional":6,"personal":6},{"professional":6,"timestamp":1658710481,"spiritual":5,"personal":5},{"personal":6,"professional":6,"timestamp":1658743973,"spiritual":5},{"timestamp":1658752413,"spiritual":5,"professional":6,"personal":7},{"personal":7,"spiritual":5,"timestamp":1658753984,"professional":7},{"professional":7,"spiritual":6,"timestamp":1658753987,"personal":7},{"spiritual":6,"timestamp":1658766701,"professional":7,"personal":6},{"professional":6,"personal":6,"spiritual":6,"timestamp":1658766703},{"professional":6,"timestamp":1658792221,"personal":7,"spiritual":6},{"timestamp":1658831178,"spiritual":6,"professional":5,"personal":7},{"personal":6,"timestamp":1658836823,"professional":7,"spiritual":6},{"personal":7,"timestamp":1658847038,"professional":7,"spiritual":6},{"timestamp":1658847039,"personal":7,"professional":7,"spiritual":7},{"professional":6,"spiritual":7,"timestamp":1658855186,"personal":6},{"personal":6,"spiritual":6,"professional":6,"timestamp":1658861193},{"personal":7,"professional":6,"timestamp":1658923343,"spiritual":6},{"professional":6,"spiritual":6,"timestamp":1658935290,"personal":6},{"professional":5,"spiritual":6,"personal":5,"timestamp":1658941680},{"timestamp":1658946831,"spiritual":6,"professional":5,"personal":6},{"professional":5,"spiritual":7,"personal":6,"timestamp":1658954179},{"personal":6,"professional":6,"timestamp":1658961371,"spiritual":7},{"timestamp":1658963264,"spiritual":7,"professional":7,"personal":6},{"personal":6,"spiritual":7,"timestamp":1658964770,"professional":8},{"timestamp":1658964771,"personal":7,"professional":8,"spiritual":7},{"timestamp":1658964903,"professional":8,"personal":6,"spiritual":7},{"professional":8,"personal":7,"timestamp":1658964905,"spiritual":7},{"spiritual":7,"professional":7,"timestamp":1658965179,"personal":7},{"spiritual":7,"personal":7,"professional":8,"timestamp":1658966712},{"timestamp":1658966994,"professional":7,"personal":7,"spiritual":7},{"timestamp":1659038335,"personal":6,"spiritual":6,"professional":6},{"timestamp":1659038345,"professional":6,"personal":6,"spiritual":5},{"spiritual":5,"timestamp":1659041127,"professional":6,"personal":7},{"spiritual":5,"timestamp":1659041737,"professional":6,"personal":6},{"timestamp":1659056473,"professional":6,"spiritual":4,"personal":6},{"spiritual":5,"timestamp":1659090794,"professional":6,"personal":6},{"personal":6,"timestamp":1659093192,"professional":7,"spiritual":5},{"personal":6,"spiritual":6,"timestamp":1659097447,"professional":7},{"personal":6,"professional":7,"timestamp":1659106139,"spiritual":5},{"timestamp":1659106148,"spiritual":5,"professional":6,"personal":5},{"spiritual":5,"professional":6,"personal":4,"timestamp":1659115143},{"professional":5,"timestamp":1659115146,"personal":4,"spiritual":4},{"timestamp":1659116223,"professional":5,"spiritual":5,"personal":5},{"spiritual":5,"personal":4,"timestamp":1659116223,"professional":5},{"timestamp":1659122596,"professional":5,"spiritual":5,"personal":6},{"spiritual":5,"personal":6,"professional":6,"timestamp":1659134854},{"timestamp":1659139185,"spiritual":5,"personal":5,"professional":6},{"professional":6,"personal":6,"timestamp":1659139185,"spiritual":5},{"spiritual":5,"professional":6,"timestamp":1659179807,"personal":6},{"timestamp":1659182654,"spiritual":5,"professional":6,"personal":5},{"timestamp":1659192976,"professional":6,"personal":6,"spiritual":5},{"spiritual":5,"personal":7,"timestamp":1659198244,"professional":6},{"spiritual":5,"timestamp":1659208122,"personal":6,"professional":6},{"timestamp":1659215554,"personal":6,"professional":5,"spiritual":5},{"professional":5,"timestamp":1659237434,"personal":6,"spiritual":5},{"timestamp":1659237434,"personal":5,"spiritual":5,"professional":5},{"personal":5,"spiritual":6,"professional":5,"timestamp":1659267631},{"professional":5,"timestamp":1659267631,"spiritual":6,"personal":6},{"timestamp":1659267631,"professional":5,"personal":6,"spiritual":6},{"personal":5,"professional":5,"spiritual":6,"timestamp":1659267631},{"timestamp":1659296450,"professional":5,"personal":5,"spiritual":6},{"professional":5,"personal":6,"spiritual":6,"timestamp":1659305203},{"professional":5,"timestamp":1659305207,"personal":6,"spiritual":5},{"timestamp":1659349025,"spiritual":5,"professional":5,"personal":5},{"spiritual":5,"timestamp":1659351421,"personal":6,"professional":5},{"spiritual":5,"personal":6,"professional":6,"timestamp":1659355523}]`)
  const { docs } = await historicCollection
    .orderBy("timestamp", "asc")
    .startAt(start.getTime() / 1000)
    .endBefore(end.getTime() / 1000)
    .get();

  return docs.map(doc => doc.data() as Score);
}

async function saveData(start: Date, end: Date, data: Score[]) {
  await fsPromise.mkdir("../data", {recursive: true});

  const startYear = start.getUTCFullYear();
  const endYear = end.getUTCFullYear();

  const startMonth = start.getUTCMonth() + 1;
  const endMonth = end.getUTCMonth() + 1;

  for (let year = startYear; year <= endYear; year++) {
    let monthStart = year === startYear ? startMonth : 1;
    let monthEnd = year === endYear ? endMonth : 12;
    for (let month = monthStart; month <= monthEnd; month++) {
      await saveOneMonth(year, month, data);
    }
  } 

  await fsPromise.writeFile("../data/latest.txt", end.toISOString(), { encoding: "utf-8"});
}

async function saveOneMonth(year: number, month: number, data: Score[]) {
  console.log(`Saving ${year}-${month}`);
  const path = `../data/${year}-${month}.json`;

  const start = new Date(`${year}-${month.toString().padStart(2, "0")}-01T00:00:00Z`);
  const end = new Date(start.getTime());
  end.setUTCMonth(end.getUTCMonth() + 1);

  const startTime = start.getTime() / 1000;
  const endTime = end.getTime() / 1000;

  const existingData: DataFile = await fsPromise
    .readFile(path, "utf-8")
    .catch(() => "{}")
    .then(data => JSON.parse(data));

  data
    .filter(elem => elem.timestamp >= startTime && elem.timestamp < endTime)
    .forEach(score => {
      existingData[score.timestamp] = formatScore(score)
    });

  await fsPromise.writeFile(path, JSON.stringify(existingData), { encoding: "utf-8" });
}

async function fetchAndSave(start: Date, end: Date) {
  const data = await fetchData(start, end);
  console.log(JSON.stringify(data));
  await saveData(start, end, data);
}

async function saveAll() {
  const start = new Date("2022-06-29T00:00:00Z");
  const end = new Date();
  await fetchAndSave(start, end);
}

async function saveSinceLatest() {
  const latestTime = await fsPromise.readFile("../data/latest.txt", "utf-8")
    .catch(error => {
      console.log("Error reading latest time");
      console.log(error);
      return "2022-06-29T00:00:00Z"
    });
  const start = new Date(latestTime);
  const end = new Date();
  await fetchAndSave(start, end);
}

saveSinceLatest();
